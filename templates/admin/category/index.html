{% extends "/admin/master.html" %}

{%block style%}
    <link rel="stylesheet" href="{{url_for('static', filename='admin/style/style.css')}}">
{%endblock%}

{%block content%}

  <div class="content-wrapper" id="app">
    <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0">Category</h1>

          </div><!-- /.col -->
        
        </div><!-- /.row -->
      </div><!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->

    <!-- Main content -->
    <section class="content">
    <button type="button" class="btn btn-primary mb-3"  @click="open_popup('create')"><i class="bi bi-plus-circle"></i> Add Category</button>
    <div class="table-responsive">
        <table class="table align-middle mb-0 shadow-sm" style="border-radius: 10px; overflow: hidden;">
            <thead>
            <tr>
                <th scope="col" class="ps-4">No</th>
                <th scope="col" class="ps-4">Image</th>
                <th scope="col" class="ps-4">Name</th>
                <th scope="col" class="text-end pe-4">Description</th>
                <th scope="col" class="text-end pe-4">Actions</th>
            </tr>
            </thead>
            <tbody>
                <tr class="table-row" v-for="(item,index) in category_list" :key="'category -'+index" v-if="category_list.length>0">
                    <td class="ps-4 fw-semibold">[[index +1]]</td>
                    <td class="ps-4 fw-semibold">
                        <img
                                v-if="item.image"
                                :src="'{{ url_for('static', filename='image/category/') }}'+item.image"
                                class="img-fluid rounded"
                                style="height: 50px; width: auto; object-fit: cover;"
                                onerror="this.src='{{ url_for('static', filename='image/no-image.png') }}'"
                        >
                        <span v-else>No Image</span>
                    </td>
                    <td class="ps-4">[[truncate(item.name,15)]]</td>
                    <td class="text-end pe-4">[[truncate(item.description, 20)]]</td>
                    <td class="text-end pe-4">
                        <button 
                                class="btn btn-light btn-sm me-1 border mr-2" 
                                @click="edit_category(item)">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                        <button 
                                class="btn btn-light btn-sm border"
                                @click="deleteItem(item.id,item.image)">
                            <i class="bi bi-trash text-danger"></i>
                        </button>
                    </td>
                </tr>
                <tr v-else>
                    <td colspan="5" class="text-center fst-italic text-muted py-3">
                        Category is empty!
                    </td>
                </tr>
            </tbody>
        </table>
    </div>



      </section>
    <!-- /.content -->
     {% include "/admin/category/modal.html" %}
  </div>

{%endblock%}

{%block script%}
    <script>
        const { createApp } = Vue;
        createApp({
            delimiters: ['[[', ']]'],
            data(){
                return{
                    category_list:[],
                    form:{
                        id:null,
                        name:null,
                        imageFile:null,
                        description:null,
                        oldImageUrl:null
                    },
                    method:null
                }
            },
            mounted(){
                this.fetchData()
            },
            methods:{
                truncate(text, length = 50) {
                    if (!text) return ''
                    return text.length > length ? text.substring(0, length) + '...' : text
                },
                onFileChange(e){
                    this.form.imageFile = e.target.files[0] || null;
                },
                open_popup(method) {
                    this.form.id=null
                    this.form.name=null
                    this.form.description=null
                    //Clear Input File Type
                    this.$refs.fileInput.value = null
                    this.form.imageFile = null
                    myModal = new bootstrap.Modal(document.getElementById('myModal'));
                    myModal.show();
                    this.method = method;
                },

                close_popup() {
                    myModal.hide()
                },
                crud(){
                    if(!this.form.name){
                        return
                    }

                    if(this.method=='create'){
                        this.createCategory();
                    }else{
                        this.updateCategory();
                    }
                },
                edit_category(item){
                    this.open_popup('update')
                    this.form.id=item.id
                    this.form.name=item.name
                    this.form.description=item.description
                    this.form.oldImageUrl=item.image
                },
                deleteItem(id,image_url){
                    let vm = this
                    let input = {
                        category_id : id,
                        image : image_url
                    }
                    Swal.fire({
                        title: "Are you sure?",
                        text: "You won't be able to revert this!",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#3085d6",
                        cancelButtonColor: "#d33",
                        confirmButtonText: "Yes, delete it!"
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $("#app").LoadingOverlay("show", {
                                background  : "#fff"
                            });
                            axios.post(
                                '/admin/category/delete',
                                input,{ withCredentials: true }
                            ).then(function(response){
                                $("#app").LoadingOverlay("hide", true);
                                vm.fetchData()
                                Swal.fire({
                                    position: "top-end",
                                    icon: "success",
                                    title: "Category Deleted!",
                                    showConfirmButton: false,
                                    timer: 1500
                                });
                            }).catch(function (error) {
                                $("#app").LoadingOverlay("hide", true);
                            })
                        }
                    })
                },
                fetchData(){
                    let vm = this
                    axios.get('/admin/category/list')
                    .then(function (response) {
                        $("#app").LoadingOverlay("show", {
                            background  : "#fff"
                        });
                        vm.category_list = response.data;
                        $("#app").LoadingOverlay("hide", true);
                    })
                    .catch(function (error) {
                        // handle error

                    })
                },
                createCategory(){
                    let vm = this
                    let input = new FormData();
                    input.append("name",this.form.name);
                    input.append("description",this.form.description);
                    input.append("image",this.form.imageFile);

                    $("#app").LoadingOverlay("show", {
                        background  : "#fff"
                    });
                    $("#app").LoadingOverlay("show");
                    axios.post(
                        '/admin/category/create',
                        input,
                        {
                            headers: {
                                'Content-Type': 'multipart/form-data'
                            },
                             withCredentials: true
                        },
                    ).then(function(response){
                        $("#app").LoadingOverlay("hide", true);
                        vm.fetchData()
                        vm.close_popup()
                    }).catch(function (error) {
                        $("#app").LoadingOverlay("hide", true);
                    })
                },
                updateCategory(){
                    let vm = this
                    let input = new FormData();
                    input.append("id",this.form.id)
                    input.append("name",this.form.name);
                    input.append("description",this.form.description);
                    input.append("image",this.form.imageFile);
                    input.append("oldImage",this.form.oldImageUrl);
                    $("#app").LoadingOverlay("show", {
                        background  : "#fff"
                    });
                    $("#app").LoadingOverlay("show");
                    axios.put(
                        '/admin/category/update',
                        input,
                        {
                            headers: {
                                'Content-Type': 'multipart/form-data'
                            },
                            withCredentials: true
                        }
                    ).then(function(response){
                        $("#app").LoadingOverlay("hide", true);

                        vm.fetchData()
                        vm.close_popup()
                    }).catch(function (error) {
                        console.log(error);
                    })
                }

            }
            
        }).mount('#app')
    </script>
{%endblock%}