{% extends "/admin/master.html" %}
{%block style%}
    <link rel="stylesheet" href="{{url_for('static', filename='admin/style/style.css')}}">
{%endblock%}
{%block content%}
  <div class="content-wrapper" id="app">
    <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0">Products</h1>

          </div><!-- /.col -->
        
        </div><!-- /.row -->
      </div><!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->

    <!-- Main content -->
    <section class="content">
    <button type="button" class="btn btn-primary mb-3"  @click="open_popup('create')"><i class="bi bi-plus-circle"></i> Add Product</button>
    <div class="table-responsive">
        <table class="table align-middle mb-0 shadow-sm" style="border-radius: 10px; overflow: hidden;">
            <thead>
            <tr>
                <th scope="col" class="ps-4">No</th>
                <th scope="col" class="ps-4">Image</th>
                <th scope="col" class="ps-4">Name</th>
                <th scope="col" class="ps-4">Description</th>
                <th scope="col" class="ps-4">Cost</th>
                <th scope="col" class="ps-4">Price</th>
                <th scope="col" class="ps-4">In Category</th>
                <th scope="col" class="ps-4">Stock</th>
                <th scope="col" class="text-end pe-4">Actions</th>
            </tr>
            </thead>
            <tbody>
                <tr class="table-row" v-for="(item,index) in product_list" :key="'product -'+index" v-if="product_list.length>0">
                    <td class="ps-4 fw-semibold">[[index +1]]</td>
                    <td class="ps-4 fw-semibold">
                        <img
                                v-if="item.image"
                                :src="'{{ url_for('static', filename='image/product/') }}'+item.image"
                                class="img-fluid rounded"
                                style="height: 50px; width: auto; object-fit: cover;"
                                onerror="this.src='{{ url_for('static', filename='image/no-image.png') }}'">
                        <span v-else>No Image</span>
                    </td>
                    <td class="ps-4">[[truncate(item.name,15)]]</td>
                    <td class="ps-4">[[truncate(item.description, 20)]]</td>
                    <td class="pe-4">[[item.cost]]</td>
                    <td class="pe-4">[[item.price]]</td>
                    <td class="pe-4">[[item.category_name]]</td>
                    <td class="pe-4">[[item.stock]]</td>
                    <td class="text-end pe-4">
                        <button 
                                class="btn btn-light btn-sm me-1 border mr-2" 
                                @click="edit_product(item)">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                        <button 
                                class="btn btn-light btn-sm border"
                                @click="deleteProduct(item.id,item.image)">
                            <i class="bi bi-trash text-danger"></i>
                        </button>
                    </td>
                </tr>
                <tr v-else>
                    <td colspan="8" class="text-center fst-italic text-muted py-3">
                        Product is empty!
                    </td>
                </tr>
            </tbody>
        </table>
    </div>



      </section>
    <!-- /.content -->
     {% include "/admin/product/modal.html" %}
  </div>

{%endblock%}

{%block script%}
    <script>
        const { createApp } = Vue;
        createApp({
            delimiters: ['[[', ']]'],
            data(){
                return{
                    product_list:[],
                    category_list:[],
                    form:{
                        id:null,
                        name:null,
                        description:null,
                        cost:null,
                        price:null,
                        category_id:null,
                        stock:null,
                        imageFile:null,
                        oldImageUrl:null
                    },
                    request_method:null
                }
            },
            mounted(){
                this.fetchData()
            },
            methods:{
                truncate(text, length = 50) {
                    if (!text) return ''
                    return text.length > length ? text.substring(0, length) + '...' : text
                },
                onFileChange(e){
                    this.form.imageFile = e.target.files[0] || null;
                },
                open_popup(request_method) {
                    this.form.id=null
                    this.form.name=null
                    this.form.description=null
                    this.form.cost=null
                    this.form.price=null
                    this.form.stock=null
                    this.form.category_id=null
                    //Clear Input File Type
                    this.$refs.fileInput.value = null
                    this.form.imageFile = null
                    myModal = new bootstrap.Modal(document.getElementById('myModal'));
                    myModal.show();
                    this.request_method = request_method;
                },
                close_popup() {
                    myModal.hide()
                },
                crud(){
                    if(!this.form.name||!this.form.cost||!this.form.price||!this.form.stock||!this.form.category_id){
                        return
                    }
                    if(this.request_method=='create'){
                        this.addProduct();
                    }else{
                        this.updateProduct();
                    }
                },
                edit_product(item){
                    this.open_popup('update')
                    this.form.id=item.id
                    this.form.name=item.name
                    this.form.description=item.description
                    this.form.cost=item.cost
                    this.form.price=item.price
                    this.form.stock=item.stock
                    this.form.oldImageUrl=item.image
                    this.form.category_id=item.category_id
                },
                deleteProduct(id,image_url){
                    let vm = this
                    let payload = {
                        product_id : id,
                        image : image_url
                    }
                    Swal.fire({
                        title: "Are you sure?",
                        text: "You won't be able to revert this!",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#3085d6",
                        cancelButtonColor: "#d33",
                        confirmButtonText: "Yes, delete it!"
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $("#app").LoadingOverlay("show", {
                                background  : "#fff"
                            });
                            axios.post(
                                '/admin/product/delete',
                                payload,{ withCredentials: true }
                            ).then(function(response){
                                $("#app").LoadingOverlay("hide", true);
                                vm.fetchData()
                                Swal.fire({
                                    position: "top-end",
                                    icon: "success",
                                    title: "Product Deleted!",
                                    showConfirmButton: false,
                                    timer: 1500
                                });

                            }).catch(function (error) {
                                $("#app").LoadingOverlay("hide", true);
                            })
                        }
                    })
                },
                fetchData(){
                    let vm = this
                    axios.get('/admin/product/list')
                    .then(function (response) {
                        $("#app").LoadingOverlay("show", {
                            background  : "#fff"
                        });
                        vm.product_list = response.data.products;
                        vm.category_list = response.data.category;
                        $("#app").LoadingOverlay("hide", true);
                    })
                    .catch(function (error) {
                        // handle error

                    })
                },
                addProduct(){
                    let vm = this
                    let input = new FormData();
                    input.append("name",this.form.name);
                    input.append("description",this.form.description);
                    input.append("cost",this.form.cost);
                    input.append("price",this.form.price);
                    input.append("category_id",this.form.category_id);
                    input.append("stock",this.form.stock);
                    input.append("image",this.form.imageFile);
                    $("#app").LoadingOverlay("show", {
                        background  : "#fff"
                    });
                    $("#app").LoadingOverlay("show");
                    axios.post(
                        '/admin/product/add',
                        input,
                        {
                            headers: {
                                'Content-Type': 'multipart/form-data'
                            },
                             withCredentials: true
                        },
                    ).then(function(response){
                        $("#app").LoadingOverlay("hide", true);
                        vm.fetchData()
                        vm.close_popup()
                        Swal.fire({
                        position: "top-end",
                        icon: response.data.message,
                        title: "Product added",
                        showConfirmButton: false,
                        timer: 1500
                    });
                    }).catch(function (error) {
                        $("#app").LoadingOverlay("hide", true);
                    })
                },
                updateProduct(){
                    let vm = this
                    let input = new FormData();
                    input.append("id",this.form.id)
                    input.append("name",this.form.name);
                    input.append("description",this.form.description);
                    input.append("cost",this.form.cost);
                    input.append("price",this.form.price);
                    input.append("stock",this.form.stock);
                    input.append("category_id",this.form.category_id);
                    input.append("image",this.form.imageFile);
                    input.append("oldImage",this.form.oldImageUrl);
                    $("#app").LoadingOverlay("show", {
                        background  : "#fff"
                    });
                    $("#app").LoadingOverlay("show");
                    axios.post(
                        '/admin/product/update',
                        input,
                        {
                            headers: {
                                'Content-Type': 'multipart/form-data'
                            },
                            withCredentials: true
                        }
                    ).then(function(response){
                        $("#app").LoadingOverlay("hide", true);

                        vm.fetchData()
                        vm.close_popup()
                    }).catch(function (error) {
                        console.log(error);
                    })
                }

            }
            
        }).mount('#app')
    </script>
{%endblock%}